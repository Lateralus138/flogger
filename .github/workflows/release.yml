name: Build and Release

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*.*.*'

jobs:
  get-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Extract version from Resource.rc
        id: version
        run: |
          VERSION_LINE=$(grep 'VALUE "FileVersion"' flogger/Resource.rc)
          VERSION=$(echo "$VERSION_LINE" | awk -F'"' '{print $4}')
          echo "version=v$VERSION" >> $GITHUB_OUTPUT
          # Determine if it's a pre-release (e.g., if version contains alpha, beta, rc)
          # For now, assuming it's not a pre-release based on the provided version format.
          echo "is_prerelease=false" >> $GITHUB_OUTPUT

  build-windows:
    needs: get-version
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2
      - name: Build Windows executable
        run: msbuild.exe flogger.sln /p:Configuration=Release /p:Platform=x64
      - name: Prepare artifact info
        id: artifact_info
        shell: pwsh
        run: |
          $exePath = "x64/Release/flogger.exe"
          $hash = (Get-FileHash -Path $exePath -Algorithm SHA256).Hash.ToLower()
          $jsonContent = @"
          {
            "schemaVersion": 1,
            "color": "2E9778",
            "label": "flogger-windows-x64.exe SHA256",
            "message": "$hash",
            "labelColor": "1d1d1d",
            "style": "for-the-badge",
            "namedLogo": "windows"
          }
          "@
          New-Item -Path "docs/json" -ItemType Directory -Force
          $jsonFileName = "flogger_windows_x64_SHA256.json"
          $jsonFilePath = "docs/json/$jsonFileName"
          Set-Content -Path $jsonFilePath -Value $jsonContent
          echo "exe_path=$exePath" >> $GITHUB_OUTPUT
          echo "json_path=$jsonFilePath" >> $GITHUB_OUTPUT
          echo "json_filename=$jsonFileName" >> $GITHUB_OUTPUT
      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: flogger-windows-x64
          path: |
            ${{ steps.artifact_info.outputs.exe_path }}
            ${{ steps.artifact_info.outputs.json_path }}

  build-linux:
    needs: get-version
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y libgtkmm-3.0-dev
      - name: Build Linux executable
        run: make releasedynamic
      - name: Prepare artifact info
        id: artifact_info
        run: |
          exe_path="release/dynamic/flogger"
          hash=$(sha256sum "$exe_path" | awk '{print $1}')
          json_filename="flogger_linux_x64_SHA256.json"
          mkdir -p docs/json
          json_filepath="docs/json/$json_filename"
          cat > "$json_filepath" << EOF
          {
            "schemaVersion": 1,
            "color": "2E9778",
            "label": "flogger-linux-x64 SHA256",
            "message": "$hash",
            "labelColor": "1d1d1d",
            "style": "for-the-badge",
            "namedLogo": "linux"
          }
          EOF
          echo "exe_path=$exe_path" >> $GITHUB_OUTPUT
          echo "json_path=$json_filepath" >> $GITHUB_OUTPUT
          echo "json_filename=$json_filename" >> $GITHUB_OUTPUT
      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: flogger-linux-x64
          path: |
            ${{ steps.artifact_info.outputs.exe_path }}
            ${{ steps.artifact_info.outputs.json_path }}

  commit-json:
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Organize JSON files
        run: |
          mkdir -p docs/json
          find artifacts -name "*.json" -exec cp {} docs/json/ \;
      - name: Commit JSON files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Docs: Add SHA256 hashes for release artifacts"
          file_pattern: "docs/json/*.json"

  create-release:
    needs: [get-version, build-windows, build-linux, commit-json]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Get executable paths
        id: executables
        run: |
          cd artifacts
          win_exe=$(find . -type f -name "flogger.exe" | sed 's|^\./||')
          linux_exe=$(find . -type f -name "flogger" -not -path "*.json*" | sed 's|^\./||')
          echo "windows_path=$win_exe" >> $GITHUB_OUTPUT
          echo "linux_path=$linux_exe" >> $GITHUB_OUTPUT
      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: |
            artifacts/${{ steps.executables.outputs.windows_path }}
            artifacts/${{ steps.executables.outputs.linux_path }}
          tag: ${{ needs.get-version.outputs.version }}
          name: Flogger ${{ needs.get-version.outputs.version }}
          prerelease: ${{ needs.get-version.outputs.is_prerelease }}
          token: ${{ secrets.GITHUB_TOKEN }}
